version: 'build-{build}-{branch}'

os: unstable
image: 
    - Visual Studio 2017
    - Ubuntu
   
build:
  verbosity: detailed
  
init:
    - git config --global core.autocrlf input
#clone_folder: c:\src # выбираем локальную директорию для клонирования
shallow_clone: true # копируем только последний коммит, без истории (git clone --depth 1)

skip_commits:
    files:
      - docs/*
      - LICENSE
      - README.md
      - .travis.yml
      - codecov.yml
      - .gitignore
  
matrix:
    fast_finish: true # останавливаемся после возникновения ошибки в каком-то из заданий

platform:
    - x64    
    - x86

configuration:
    - Release

branches:
  only:
    - master
    - develop
    
########## WINDOWS ##########
for:
-
    matrix:
        only:
            - image: Visual Studio 2017
        - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
          CONAN_VISUAL_VERSIONS: 15
          CONAN_BUILD_TYPES: Release
          TOOLCHAIN: msvc15
          compiler: Visual Studio 15 2017
          generator: "Visual Studio 15 2017"
          CXX_STANDARD: 14
    environment:
        PYTHON: C:\\Python37
        CODECOV_TOKEN:
            secure: e8qe5I3ngSiMDPZsLfLBP7iCZJHrFD8gsXAYTkfQ1HL09UBk10s4vWNEDVMnFoM8
        BUILD_CONFIG: $(configuration)
        COVERALLS_REPO_TOKEN:
            secure: /W0ImKAfLG96HA1nlkhhW0ntoJCRq7wps5
        APPVEYOR_RDP_PASSWORD: 1234as!&

    environment:
        PYTHON: C:\\Python37
        CODECOV_TOKEN:
            secure: e8qe5I3ngSiMDPZsLfLBP7iCZJHrFD8gsXAYTkfQ1HL09UBk10s4vWNEDVMnFoM8
        BUILD_CONFIG: $(configuration)
        COVERALLS_REPO_TOKEN:
            secure: /W0ImKAfLG96HA1nlkhhW0ntoJCRq7wps5
        APPVEYOR_RDP_PASSWORD: 1234as!&
        matrix:
    install:
        - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
        - set PATH=%PATH%;%PYTHON%/Scripts/
        - set PATH=%PATH%;C:/Program Files (x86)/Conan/conan
        
        - cmd: echo "Downloading conan..."
        - pip install conan --upgrade
        - pip install conan_package_tools
        - conan user # It creates the conan data directory
        - cmd: conan --version
        - conan remote add conan-center https://conan.bintray.com
        - conan remote add bincrafters https://api.bintray.com/conan/conan-community/conan
        - conan remote list
        
        - cmd: ECHO %PROCESSOR_ARCHITECTURE%
        - cmd: reg query "HKLM\System\CurrentControlSet\Control\Session Manager\Environment" /v PROCESSOR_ARCHITECTURE
        - cmd: echo %CONFIGURATION%

    before_build:
      - cmd: dir
      - mkdir build && cd build
      - conan install ..
      - echo y | conan package ..
      - cmake -A %platform% -G "Visual Studio 15 2017" ..
        
    build_script:
      - cmake --build .

    test_script:
        - ctest --output-on-failure -C %configuration%

    on_finish:
        #- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

    artifacts:
        - path: ./build
          name: artifacts
    install:
        - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
        - set PATH=%PATH%;%PYTHON%/Scripts/
        - set PATH=%PATH%;C:/Program Files (x86)/Conan/conan
        
        - cmd: echo "Downloading conan..."
        - pip install conan --upgrade
        - pip install conan_package_tools
        - conan user # It creates the conan data directory
        - cmd: conan --version
        - conan remote add conan-center https://conan.bintray.com
        - conan remote add bincrafters https://api.bintray.com/conan/conan-community/conan
        - conan remote list
        
        - cmd: ECHO %PROCESSOR_ARCHITECTURE%
        - cmd: reg query "HKLM\System\CurrentControlSet\Control\Session Manager\Environment" /v PROCESSOR_ARCHITECTURE
        - cmd: echo %CONFIGURATION%

    before_build:
      - cmd: dir
      - mkdir build && cd build
      - conan install ..
      - echo y | conan package ..
      - cmake -A %platform% -G "Visual Studio 15 2017" ..
        
    build_script:
      - cmake --build .

    test_script:
        - ctest --output-on-failure -C %configuration%

    on_finish:
        #- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

    artifacts:
        - path: ./build
          name: artifacts

########## LINUX ##########
for:
-
  matrix:
        only:
            - image: Ubuntu
        - WORKER_IMAGE: Ubuntu
          CXX: g++-7
          CC: gcc-7
          BUILD_COVERAGE: ON
          CXX_STANDARD: 14
    environment:
        CODECOV_TOKEN:
            secure: e8qe5I3ngSiMDPZsLfLBP7iCZJHrFD8gsXAYTkfQ1HL09UBk10s4vWNEDVMnFoM8
        BUILD_CONFIG: $(configuration)
        COVERALLS_REPO_TOKEN:
            secure: /W0ImKAfLG96HA1nlkhhW0ntoJCRq7wps5
        APPVEYOR_RDP_PASSWORD: 1234as!&
        CMAKE_CXX_COMPILER:g++-5
        CMAKE_C_COMPILER:gcc-5

    install:
        - echo "Downloading conan..."
        - pip install conan --upgrade
        - pip install conan_package_tools
        - conan user # It creates the conan data directory
        - conan --version
        - conan remote add conan-center https://conan.bintray.com
        - conan remote add bincrafters https://api.bintray.com/conan/conan-community/conan
        - conan remote list
        
        - echo %PROCESSOR_ARCHITECTURE%
        - echo %CONFIGURATION%


    before_build:
      - cmd: dir
      - mkdir build && cd build
      - conan install ..
      - echo y | conan package ..
      - cmake -A %platform% ..
        
    build_script:
      - cmake --build .

    test_script:
        - ctest --output-on-failure -C %configuration%

    on_finish:
        #- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

    artifacts:
        - path: ./build
          name: artifacts